<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Professional Mode</title>

<style>
html,body{
  margin:0;
  height:100%;
  font-family:system-ui;
}

#screen{
  min-height:100vh;
  min-height:100dvh;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  text-align:center;
  transition:background 0.2s ease;
  padding:20px;
  -webkit-tap-highlight-color:transparent;
  touch-action:manipulation;
  user-select:none;
}

#topBar{
  position:absolute;
  top:20px;
  left:20px;
  right:20px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:12px;
  flex-wrap:wrap;
}

#welcome{
  position:absolute;
  top:58px;
  font-size:16px;
}
#homeLink{
  color:#fff;
  text-decoration:none;
  opacity:.9;
  font-size:14px;
}
#homeLink:hover{
  text-decoration:underline;
}
#modeLink{
  color:#fff;
  text-decoration:none;
  opacity:.9;
  font-size:14px;
}
#modeLink:hover{
  text-decoration:underline;
}

#message{
  font-size:clamp(32px, 6vw, 56px);
  font-weight:700;
  white-space:pre-line;
}

#result{
  margin-top:15px;
  font-size:clamp(14px, 3.6vw, 20px);
  white-space:pre-line;
}

#leaderboardMeta{
  margin-top:14px;
  width:100%;
  max-width:min(900px, 92vw);
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-size:clamp(12px, 3.2vw, 14px);
  gap:12px;
  flex-wrap:wrap;
}

#leaderboardLink{
  color:#fff;
  text-decoration:none;
  opacity:.9;
}
#leaderboardLink:hover{
  text-decoration:underline;
}

#leaderboard{
  width:100%;
  max-width:min(900px, 92vw);
  overflow-x:auto;
}

table{
  border-collapse:collapse;
  margin-top:20px;
  width:100%;
  font-size:clamp(12px, 2.8vw, 14px);
}

td,th{
  border:1px solid #fff;
  padding:6px 10px;
  text-align:left;
  word-break:break-word;
}

.me-row{
  background:rgba(255,255,255,0.12);
  font-weight:600;
}

@media (max-width: 520px){
  #leaderboardMeta{
    flex-direction:column;
    align-items:flex-start;
  }
  td,th{
    padding:6px 6px;
  }
  th{
    white-space:nowrap;
  }
}

</style>
</head>

<body>

<div id="screen">
  <div id="topBar">
    <a id="homeLink" href="https://www.xpsxp.org">返回主站</a>
    <a id="modeLink" href="/">返回模式选择</a>
  </div>
  <div id="welcome"></div>
  <div id="message">Loading...</div>
  <div id="result"></div>
  <div id="leaderboardMeta" style="display:none;">
    <div id="myRank"></div>
    <a id="leaderboardLink" href="/leaderboard.html?mode=pro">完整排行榜</a>
  </div>
  <div id="leaderboard" style="display:none;"></div>
</div>

<script>

// ==========================
// Language
// ==========================
const browserLang = (navigator.language || "").toLowerCase();
const lang = browserLang.includes("zh") ? "zh" : "en";

const T = {
  en: {
    loading: "Professional Mode",
    welcomeBack: (n) => `Welcome back, ${n}`,
    clickToStart: "Click anywhere to start (5 trials)",
    waitGreen: (i) => `Trial ${i}/5\nWait for green...`,
    clickNow: "CLICK!",
    tooEarly: "Too early!\nRestarting round...",
    recorded: (ms, i) => `Recorded: ${ms} ms\nAuto starting trial ${i}/5...`,
    average: (avg) => `Average: ${avg} ms\nClick to try again`,
    trials: (arr) => `Trials: ${arr.join(", ")} ms`,
    best: (b) => `Best: ${b} ms`,
    back: "Back to Mode Select",
    rankLine: (r) => `Your rank: #${r}`
  },
  zh: {
    loading: "专业模式",
    welcomeBack: (n) => `欢迎回来，${n}`,
    clickToStart: "点击任意位置开始（连续5次取平均）",
    waitGreen: (i) => `第 ${i}/5 次\n等待变绿...`,
    clickNow: "点击！",
    tooEarly: "太早了！\n本轮已重置...",
    recorded: (ms, i) => `记录：${ms} ms\n自动进入第 ${i}/5 次...`,
    average: (avg) => `平均：${avg} ms\n点击再来一轮`,
    trials: (arr) => `五次成绩：${arr.join(", ")} ms`,
    best: (b) => `最好：${b} ms`,
    back: "返回模式选择",
    rankLine: (r) => `当前名次：第 ${r} 名`
  }
};

// ==========================
// Identity
// ==========================
function getBrowserId(){
  let bid=localStorage.getItem("reaction_bid");
  if(bid) return bid;
  const bytes=new Uint8Array(16);
  crypto.getRandomValues(bytes);
  bid=Array.from(bytes).map(b=>b.toString(16).padStart(2,"0")).join("");
  localStorage.setItem("reaction_bid",bid);
  return bid;
}
const bid=getBrowserId();

let myName=null;
let hasResult=false;
let welcomeHideTimer=null;

async function checkIdentity(){
  const r=await fetch(`/api/me?bid=${bid}`);
  const j=await r.json();
  if(!j.ok || !j.claimed){
    window.location.href="/welcome.html";
    return;
  }
  myName=j.name;
  document.getElementById("welcome").textContent=
    T[lang].welcomeBack(myName);
  scheduleWelcomeHide();
  reset();
}

function scheduleWelcomeHide(){
  const welcomeEl = document.getElementById("welcome");
  if (!welcomeEl) return;
  welcomeEl.style.display = "";
  if (welcomeHideTimer) clearTimeout(welcomeHideTimer);
  welcomeHideTimer = setTimeout(() => {
    welcomeEl.style.display = "none";
  }, 5000);
}

// ==========================
// 5-trial continuous logic
// ==========================
let state="idle";
let startTime=null;
let timeout=null;

let trialCount=0;
let trials=[];

const screen=document.getElementById("screen");
const message=document.getElementById("message");
const result=document.getElementById("result");
const leaderboardDiv=document.getElementById("leaderboard");
const myRankDiv=document.getElementById("myRank");
const leaderboardMeta=document.getElementById("leaderboardMeta");

function setScreen(color,msg){
  screen.style.background=color;
  message.textContent=msg;
}

function reset(){
  state="idle";
  trialCount=0;
  trials=[];
  if(timeout){ clearTimeout(timeout); timeout=null; }
  setScreen("#3b82f6", T[lang].clickToStart);
  result.textContent="";
}

function scheduleNextTrial(){
  const interDelay=600;
  setScreen("#dc2626", T[lang].waitGreen(trialCount+1));
  state="waiting";

  timeout=setTimeout(()=>{
    const randomDelay=Math.random()*3000+1000;
    timeout=setTimeout(()=>{
      state="ready";
      const commitReady = () => {
        setScreen("#22c55e", T[lang].clickNow);
        startTime=performance.now();
      };
      if (!isCoarse && "requestAnimationFrame" in window) {
        requestAnimationFrame(commitReady);
      } else {
        commitReady();
      }
    },randomDelay);
  },interDelay);
}

const isCoarse = window.matchMedia && window.matchMedia("(pointer: coarse)").matches;
const ACTION_DEBOUNCE_MS = isCoarse ? 450 : 200;
let lastActionAt=0;
let handlingAction=false;
function eventTime(evt){
  if (!evt || typeof evt.timeStamp !== "number") return performance.now();
  return evt.timeStamp > 0 ? evt.timeStamp : performance.now();
}
async function handleAction(evt){
  if (handlingAction) return;
  handlingAction=true;
  setTimeout(()=>{ handlingAction=false; }, 50);
  if (evt && typeof evt.detail === "number" && evt.detail > 1) return;
  const now=Date.now();
  if(now-lastActionAt<ACTION_DEBOUNCE_MS) return;
  lastActionAt=now;
  if (evt.target && evt.target.closest && evt.target.closest("a")) return;

  if(state==="idle"){
    scheduleNextTrial();
    return;
  }

  if(state==="waiting"){
    if(timeout) clearTimeout(timeout);
    reset();
    setScreen("#3b82f6", T[lang].tooEarly);
    return;
  }

  if(state==="ready"){
    const clickTime = isCoarse ? performance.now() : eventTime(evt);
    const ms=Math.round(clickTime-startTime);
    trials.push(ms);
    trialCount++;

    if(trialCount<5){
      setScreen("#3b82f6",
        T[lang].recorded(ms, trialCount+1));
      state="idle";
      scheduleNextTrial();
      return;
    }

    const avg=Math.round(trials.reduce((a,b)=>a+b,0)/5);
    state="result";
    setScreen("#3b82f6", T[lang].average(avg));
    result.textContent=T[lang].trials(trials);

    const r=await fetch("/api/pro/submit",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({name: myName, ms: avg})
    });
    const j=await r.json();
    if(j.ok){
      result.textContent+="\n"+T[lang].best(j.best_ms);
      if (!hasResult) {
        hasResult = true;
        leaderboardMeta.style.display = "flex";
        leaderboardDiv.style.display = "block";
      }
      loadLeaderboard();
    }
    return;
  }

  if(state==="result"){
    reset();
  }

}

if (isCoarse) {
  screen.addEventListener("click", handleAction, { passive: true });
} else if (window.PointerEvent) {
  screen.addEventListener("pointerdown", handleAction, { passive: true });
} else {
  screen.addEventListener("mousedown", handleAction);
}

// ==========================
// Leaderboard
// ==========================
async function loadLeaderboard(){
  const r=await fetch(`/api/pro/leaderboard?name=${encodeURIComponent(myName)}`);
  const j=await r.json();
  if(!j.ok) return;

  let html="<table><tr><th>#</th><th>Name</th><th>Best</th></tr>";
  const inTop = j.rows.some((row)=>row.name===myName);
  j.rows.forEach((row,i)=>{
    const meClass = row.name===myName ? " class='me-row'" : "";
    html+=`<tr${meClass}><td>${i+1}</td>
            <td>${row.name}</td>
            <td>${row.best_ms}</td></tr>`;
  });
  if (j.me && j.me.rank && (!inTop || j.me.rank > j.rows.length)) {
    html+=`<tr class="me-row">
      <td>${j.me.rank}</td>
      <td>${j.me.name}</td>
      <td>${j.me.best_ms}</td>
    </tr>`;
  }
  html+="</table>";
  leaderboardDiv.innerHTML=html;
  myRankDiv.textContent = j.me && j.me.rank ? T[lang].rankLine(j.me.rank) : "";
}

// ==========================
// Start
// ==========================
setScreen("#3b82f6", T[lang].loading);
checkIdentity();

</script>

<script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"version":"2024.11.0","token":"23a4e4680985457fa4ecb61d81dc541f","r":1,"server_timing":{"name":{"cfCacheStatus":true,"cfEdge":true,"cfExtPri":true,"cfL4":true,"cfOrigin":true,"cfSpeedBrain":true},"location_startswith":null}}' crossorigin="anonymous"></script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9d34ba497dd42333',t:'MTc3MTk5NjU1NQ=='};var a=document.createElement('script');a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script><script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"version":"2024.11.0","token":"23a4e4680985457fa4ecb61d81dc541f","r":1,"server_timing":{"name":{"cfCacheStatus":true,"cfEdge":true,"cfExtPri":true,"cfL4":true,"cfOrigin":true,"cfSpeedBrain":true},"location_startswith":null}}' crossorigin="anonymous"></script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9d34bf36f99f2333',t:'MTc3MTk5Njc1Nw=='};var a=document.createElement('script');a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script><script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"version":"2024.11.0","token":"23a4e4680985457fa4ecb61d81dc541f","r":1,"server_timing":{"name":{"cfCacheStatus":true,"cfEdge":true,"cfExtPri":true,"cfL4":true,"cfOrigin":true,"cfSpeedBrain":true},"location_startswith":null}}' crossorigin="anonymous"></script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9d34bfe81d302333',t:'MTc3MTk5Njc4NQ=='};var a=document.createElement('script');a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script><script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"version":"2024.11.0","token":"23a4e4680985457fa4ecb61d81dc541f","r":1,"server_timing":{"name":{"cfCacheStatus":true,"cfEdge":true,"cfExtPri":true,"cfL4":true,"cfOrigin":true,"cfSpeedBrain":true},"location_startswith":null}}' crossorigin="anonymous"></script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9d34c6a93f045eb1',t:'MTc3MTk5NzA2Mg=='};var a=document.createElement('script');a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script><script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"version":"2024.11.0","token":"23a4e4680985457fa4ecb61d81dc541f","r":1,"server_timing":{"name":{"cfCacheStatus":true,"cfEdge":true,"cfExtPri":true,"cfL4":true,"cfOrigin":true,"cfSpeedBrain":true},"location_startswith":null}}' crossorigin="anonymous"></script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9d34ce371ad5e8ea',t:'MTc3MTk5NzM3Mg=='};var a=document.createElement('script');a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script><script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9d34d17b2ad7eb6a',t:'MTc3MTk5NzUwNQ=='};var a=document.createElement('script');a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script><script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"version":"2024.11.0","token":"23a4e4680985457fa4ecb61d81dc541f","r":1,"server_timing":{"name":{"cfCacheStatus":true,"cfEdge":true,"cfExtPri":true,"cfL4":true,"cfOrigin":true,"cfSpeedBrain":true},"location_startswith":null}}' crossorigin="anonymous"></script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9d34da9b7cef863e',t:'MTc3MTk5Nzg3OQ=='};var a=document.createElement('script');a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script><script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"version":"2024.11.0","token":"23a4e4680985457fa4ecb61d81dc541f","r":1,"server_timing":{"name":{"cfCacheStatus":true,"cfEdge":true,"cfExtPri":true,"cfL4":true,"cfOrigin":true,"cfSpeedBrain":true},"location_startswith":null}}' crossorigin="anonymous"></script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9d350b9248e7c0b2',t:'MTc3MTk5OTg4NQ=='};var a=document.createElement('script');a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script><script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"version":"2024.11.0","token":"23a4e4680985457fa4ecb61d81dc541f","r":1,"server_timing":{"name":{"cfCacheStatus":true,"cfEdge":true,"cfExtPri":true,"cfL4":true,"cfOrigin":true,"cfSpeedBrain":true},"location_startswith":null}}' crossorigin="anonymous"></script>
</body>
</html>

