<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>2048</title>
  <link rel="stylesheet" href="/style.css">
</head>
<body>
  <div class="wrap">
    <h1>2048</h1>
    <div class="nav">
      <a class="btn" href="/">Home</a>
      <a class="btn" href="/leaderboard.html">Leaderboard</a>
    </div>
    <div class="card">
      <p>Use arrow keys. Score auto-submits when improved.</p>
      <div>Score: <b id="score">0</b></div>
      <div id="board2048"></div>
      <div class="status" id="status"></div>
    </div>
  </div>

  <script src="/app.js"></script>
  <script>
    const size = 4;
    let grid = Array.from({ length: size }, () => Array(size).fill(0));
    let score = 0;
    const boardEl = document.getElementById("board2048");
    const scoreEl = document.getElementById("score");
    const statusEl = document.getElementById("status");

    function addRandom() {
      const empty = [];
      for (let r = 0; r < size; r++) for (let c = 0; c < size; c++) if (!grid[r][c]) empty.push([r, c]);
      if (!empty.length) return;
      const [r, c] = empty[Math.floor(Math.random() * empty.length)];
      grid[r][c] = Math.random() < 0.9 ? 2 : 4;
    }

    function draw() {
      boardEl.innerHTML = "";
      scoreEl.textContent = score;
      for (let r = 0; r < size; r++) {
        for (let c = 0; c < size; c++) {
          const v = grid[r][c];
          const d = document.createElement("div");
          d.className = "tile";
          d.textContent = v ? v : "";
          d.style.background = v ? `hsl(${220 - Math.min(180, Math.log2(v) * 18)}, 45%, ${35 + Math.min(20, Math.log2(v) * 2)}%)` : "#22324f";
          boardEl.appendChild(d);
        }
      }
    }

    function slideRow(row) {
      const arr = row.filter(Boolean);
      for (let i = 0; i < arr.length - 1; i++) {
        if (arr[i] === arr[i + 1]) {
          arr[i] *= 2;
          score += arr[i];
          arr.splice(i + 1, 1);
        }
      }
      while (arr.length < size) arr.push(0);
      return arr;
    }

    function rotate(times) {
      for (let t = 0; t < times; t++) {
        const n = Array.from({ length: size }, () => Array(size).fill(0));
        for (let r = 0; r < size; r++) for (let c = 0; c < size; c++) n[c][size - 1 - r] = grid[r][c];
        grid = n;
      }
    }

    function move(dir) {
      const map = { left: 0, down: 1, right: 2, up: 3 };
      rotate(map[dir]);
      const before = JSON.stringify(grid);
      for (let r = 0; r < size; r++) grid[r] = slideRow(grid[r]);
      rotate((4 - map[dir]) % 4);
      if (JSON.stringify(grid) !== before) {
        addRandom();
        draw();
        submit();
      }
    }

    async function submit() {
      try {
        await GAMES.api("/api/scores/submit", {
          method: "POST",
          body: JSON.stringify({ game: "2048", value: score })
        }, true);
        GAMES.setStatus(statusEl, "Score updated", true);
      } catch {
        GAMES.setStatus(statusEl, "Not logged in, score not submitted");
      }
    }

    document.addEventListener("keydown", (e) => {
      if (e.key === "ArrowLeft") move("left");
      if (e.key === "ArrowRight") move("right");
      if (e.key === "ArrowUp") move("up");
      if (e.key === "ArrowDown") move("down");
    });

    addRandom();
    addRandom();
    draw();
  </script>

</body>
</html>

